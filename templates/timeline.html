{% extends "layout.html" %}

{% block head %}
<style>
  .task-card {
    margin-bottom: 1.5rem;
    transition: all 0.3s ease;
  }
  .task-card:hover {
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    transform: translateY(-3px);
  }
  .delay-info {
    font-weight: bold;
  }
  .task-actions {
    margin-top: 1rem;
  }
  .task-badge {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    margin-right: 0.5rem;
  }
  .badge-assigned {
    background-color: #3498db;
    color: white;
  }
  .badge-disputed {
    background-color: #e74c3c;
    color: white;
  }
  .badge-to-validated {
    background-color: #f39c12;
    color: white;
  }
  .badge-done {
    background-color: #2ecc71;
    color: white;
  }
  .badge-info {
    background-color: #3498db;
    color: white;
  }
  .badge-transfer-pending {
    background-color: #9b59b6;
    color: white;
  }
  .loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100px;
  }
  .floating-button {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background-color: #f5365c;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
  }
  .floating-button:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
  }
  #tasks-container {
    min-height: 200px;
  }
  .no-tasks {
    text-align: center;
    padding: 2rem;
    font-style: italic;
    color: #777;
  }

  /* Styles pour les priorités */
  .priority-high {
    border-left: 5px solid #e74c3c;
  }
  .priority-medium {
    border-left: 5px solid #f39c12;
  }
  .priority-low {
    border-left: 5px solid #2ecc71;
  }

  .priority-badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 0.25rem;
    margin-right: 0.5rem;
    font-size: 0.75rem;
    font-weight: bold;
  }
  .priority-badge-high {
    background-color: #e74c3c;
    color: white;
  }
  .priority-badge-medium {
    background-color: #f39c12;
    color: white;
  }
  .priority-badge-low {
    background-color: #2ecc71;
    color: white;
  }

  /* Styles pour les informations de temps */
  .time-info {
    font-size: 0.85rem;
    margin-top: 0.5rem;
  }
  .time-overdue {
    color: #e74c3c;
    font-weight: bold;
  }
  .time-critical {
    color: #e74c3c;
  }
  .time-high {
    color: #f39c12;
  }
  .time-medium {
    color: #3498db;
  }
  .time-low {
    color: #2ecc71;
  }

  /* Style pour le menu de priorité */
  .priority-menu {
    display: inline-block;
  }

  /* Style pour les rôles */
  .role-badge {
    background-color: #5e72e4;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
  }

  /* Style pour l'historique des tâches */
  .task-history {
    font-size: 0.85rem;
    margin-top: 1rem;
    padding: 0.5rem;
    background-color: #f8f9fa;
    border-radius: 0.25rem;
  }
  .task-history-title {
    font-weight: bold;
    margin-bottom: 0.5rem;
  }
  .task-history-item {
    margin-bottom: 0.25rem;
    padding: 0.25rem;
    border-bottom: 1px solid #eee;
  }
  .task-history-action {
    font-weight: bold;
  }
  .task-history-date {
    color: #6c757d;
    float: right;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="page-header min-height-200 border-radius-xl mt-4" style="background-image: url('/static/assets/img/bg-task.jpg'); background-position-y: 50%;">
  </div>
  <div class="card card-body blur shadow-blur mx-4 mt-n6 overflow-hidden">
    <div class="row gx-4">
      <div class="col-auto my-auto">
        <div class="h-100">
          <h5 class="mb-1">
            Mes tâches
          </h5>
          <p class="mb-0 font-weight-bold text-sm">
            {% if error %}
              {{ error }}
            {% else %}
              Gérez vos tâches et suivez leur progression
            {% endif %}
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header pb-0 p-3">
          <div class="row">
            <div class="col-md-6">
              <h6 class="mb-0">Liste des tâches</h6>
            </div>
            <div class="col-md-6 d-flex justify-content-end">
              <div class="dropdown me-2">
                <button class="btn bg-gradient-primary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fa fa-filter me-2"></i> Filtrer par état
                </button>
                <ul class="dropdown-menu" aria-labelledby="filterDropdown">
                  <li><a class="dropdown-item filter-option" data-filter="all" href="#">Toutes les tâches</a></li>
                  <li><a class="dropdown-item filter-option" data-filter="assigned" href="#">Assignées</a></li>
                  <li><a class="dropdown-item filter-option" data-filter="disputed" href="#">Contestées</a></li>
                  <li><a class="dropdown-item filter-option" data-filter="to_validated" href="#">À valider</a></li>
                  <li><a class="dropdown-item filter-option" data-filter="transfer_pending" href="#">Cession en attente</a></li>
                  <li><a class="dropdown-item filter-option" data-filter="done" href="#">Terminées</a></li>
                </ul>
              </div>
              <div class="dropdown">
                <button class="btn bg-gradient-info dropdown-toggle" type="button" id="priorityFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fa fa-sort-amount-down me-2"></i> Filtrer par priorité
                </button>
                <ul class="dropdown-menu" aria-labelledby="priorityFilterDropdown">
                  <li><a class="dropdown-item priority-filter-option" data-priority="all" href="#">Toutes les priorités</a></li>
                  <li><a class="dropdown-item priority-filter-option" data-priority="high" href="#">Haute</a></li>
                  <li><a class="dropdown-item priority-filter-option" data-priority="medium" href="#">Moyenne</a></li>
                  <li><a class="dropdown-item priority-filter-option" data-priority="low" href="#">Faible</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body p-3">
          <div id="tasks-container">
            <div class="loading-spinner">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<a href="/createTask" class="floating-button">
  <i class="fa fa-plus"></i>
</a>

<!-- Modal pour changer la priorité -->
<div class="modal fade" id="priorityModal" tabindex="-1" aria-labelledby="priorityModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="priorityModalLabel">Changer la priorité</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Choisissez la nouvelle priorité pour cette tâche :</p>
        <input type="hidden" id="taskIdForPriority" value="">
        <div class="form-check">
          <input class="form-check-input" type="radio" name="taskPriority" id="priorityHigh" value="high">
          <label class="form-check-label" for="priorityHigh">
            <span class="priority-badge priority-badge-high">Haute</span>
          </label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="taskPriority" id="priorityMedium" value="medium" checked>
          <label class="form-check-label" for="priorityMedium">
            <span class="priority-badge priority-badge-medium">Moyenne</span>
          </label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="taskPriority" id="priorityLow" value="low">
          <label class="form-check-label" for="priorityLow">
            <span class="priority-badge priority-badge-low">Faible</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" id="savePriorityBtn">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour réassigner une tâche -->
<div class="modal fade" id="reassignModal" tabindex="-1" aria-labelledby="reassignModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reassignModalLabel">Réassigner la tâche</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Sélectionnez les utilisateurs à qui vous souhaitez attribuer cette tâche:</p>
        <input type="hidden" id="taskIdForReassign" value="">
        <div class="mb-3">
          <select class="form-select" id="reassignUserSelect" multiple>
            <!-- Les options seront remplies dynamiquement -->
          </select>
          <div class="form-text">Maintenez Ctrl (ou Cmd sur Mac) pour sélectionner plusieurs utilisateurs.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" id="reassignBtn" onclick="reassignTask()">Réassigner</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour transférer la propriété d'une tâche -->
<div class="modal fade" id="transferOwnershipModal" tabindex="-1" aria-labelledby="transferOwnershipModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="transferOwnershipModalLabel">Transférer la propriété de la tâche</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Sélectionnez l'utilisateur à qui vous souhaitez transférer la propriété de cette tâche:</p>
        <input type="hidden" id="taskIdForOwnershipTransfer" value="">
        <div class="mb-3">
          <select class="form-select" id="ownershipTransferSelect">
            <option value="" disabled selected>Choisir un utilisateur</option>
            <!-- Les options seront remplies dynamiquement -->
          </select>
          <div class="form-text">Le nouvel utilisateur deviendra le propriétaire de la tâche et pourra la gérer.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" id="transferOwnershipBtn" onclick="transferTaskOwnership()">Transférer</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour voir l'historique d'une tâche -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="historyModalLabel">Historique de la tâche</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="taskHistoryContent">
          <!-- L'historique sera chargé dynamiquement ici -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Task state translations
  const stateTranslations = {
    'assigned': 'Assignée',
    'disputed': 'Contestée',
    'to_validated': 'En attente de validation',
    'done': 'Terminée',
    'deleted': 'Supprimée',
    'transfer_pending': 'Cession en attente'
  };

  // Task priority translations
  const priorityTranslations = {
    'high': 'Haute',
    'medium': 'Moyenne',
    'low': 'Faible'
  };

  // Action translations for history
  const actionTranslations = {
    'assigned': 'Assignée',
    'reassigned': 'Réassignée',
    'released': 'Libérée',
    'unassigned': 'Désassignée',
    'disputed': 'Contestée',
    'validated': 'Validée',
    'completed': 'Terminée',
    'reopened': 'Réouverte',
    'ownership_transferred': 'Propriété transférée'
  };

  // Get state badge class
  function getStateBadgeClass(state) {
    switch (state) {
      case 'assigned': return 'badge-assigned';
      case 'disputed': return 'badge-disputed';
      case 'to_validated': return 'badge-to-validated';
      case 'done': return 'badge-done';
      case 'transfer_pending': return 'badge-transfer-pending';
      default: return '';
    }
  }

  // Format date
  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('fr-FR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // Format delay
  function formatDelay(delay) {
    if (!delay) return '';

    let delayText = '';
    if (delay.days > 0) {
      delayText += `${delay.days} jour${delay.days > 1 ? 's' : ''} `;
    }
    if (delay.hours > 0) {
      delayText += `${delay.hours} heure${delay.hours > 1 ? 's' : ''} `;
    }
    if (delay.minutes > 0) {
      delayText += `${delay.minutes} minute${delay.minutes > 1 ? 's' : ''} `;
    }
    return delayText.trim();
  }

  // Get time info class
  function getTimeInfoClass(timeInfo) {
    if (!timeInfo) return '';

    if (timeInfo.status === 'overdue') {
      return 'time-overdue';
    } else if (timeInfo.status === 'upcoming') {
      switch (timeInfo.urgency) {
        case 'critical': return 'time-critical';
        case 'high': return 'time-high';
        case 'medium': return 'time-medium';
        default: return 'time-low';
      }
    }
    return '';
  }

  // Get priority badge
  function getPriorityBadge(priority) {
    const priorityText = priorityTranslations[priority] || 'Moyenne';
    return `<span class="priority-badge priority-badge-${priority}">${priorityText}</span>`;
  }

  // Get current user's role
  const userRole = "{{ user_role }}";
  // Get current user's email
  const userEmail = "{{ user_info.email }}";

  // Variable pour stocker la liste des utilisateurs
  let usersForTransfer = [];

  // Fonction pour charger la liste des utilisateurs
  function loadUsers() {
    fetch('/api/users')
      .then(response => response.json())
      .then(users => {
        usersForTransfer = users;
      })
      .catch(error => {
        console.error('Error fetching users:', error);
      });
  }

  // Charger les utilisateurs au chargement de la page
  document.addEventListener('DOMContentLoaded', loadUsers);

  // Fonction pour ouvrir le modal d'historique des tâches
  function openHistoryModal(event, taskId, history) {
    event.preventDefault();

    // Mettre à jour le contenu du modal
    const historyContent = document.getElementById('taskHistoryContent');

    if (!history || history.length === 0) {
      historyContent.innerHTML = '<p>Aucun historique disponible pour cette tâche.</p>';
    } else {
      let historyHTML = `<div class="task-history">`;
      historyHTML += `<div class="task-history-title">Historique des actions</div>`;

      history.forEach(entry => {
        const actionText = actionTranslations[entry.action] || entry.action;
        historyHTML += `
          <div class="task-history-item">
            <span class="task-history-action">${actionText}</span> par ${entry.user_email}
            <span class="task-history-date">${formatDate(entry.timestamp)}</span>
          </div>
        `;
      });

      historyHTML += `</div>`;
      historyContent.innerHTML = historyHTML;
    }

    // Afficher le modal
    const historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
    historyModal.show();
  }

  // Fonction pour libérer une tâche (la rendre disponible pour d'autres)
  function releaseTask(event, taskId) {
    event.preventDefault();

    if (!confirm("Voulez-vous vraiment libérer cette tâche ? Elle deviendra disponible pour d'autres personnes.")) {
      return;
    }

    // Disable the button to prevent double clicks
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> En cours...';

    // Make API call
    fetch(`/api/tasks/${taskId}/release`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Refresh tasks after successful action
        fetchTasks();
        alert("La tâche a été libérée avec succès. Elle est maintenant disponible dans la section 'Tâches disponibles'.");
      } else {
        const errorMessage = data.error ? data.error : 'Une erreur inconnue est survenue';
        alert(`Erreur: ${errorMessage}`);
        // Restore button
        button.disabled = false;
        button.innerHTML = originalText;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert(`Une erreur est survenue: ${error.message}`);
      // Restore button
      button.disabled = false;
      button.innerHTML = originalText;
    });
  }

  // Fonction pour ouvrir le modal de réassignation
  function openReassignModal(event, taskId, currentAssignees) {
    event.preventDefault();

    // Mettre à jour l'ID de la tâche
    document.getElementById('taskIdForReassign').value = taskId;

    // Remplir le select avec les utilisateurs
    const userSelect = document.getElementById('reassignUserSelect');
    userSelect.innerHTML = '';

    // Charger les utilisateurs dans le select
    usersForTransfer.forEach(user => {
      const option = document.createElement('option');
      option.value = user.name;
      option.textContent = user.name;
      option.selected = currentAssignees.includes(user.email);
      userSelect.appendChild(option);
    });

    // Afficher le modal
    const reassignModal = new bootstrap.Modal(document.getElementById('reassignModal'));
    reassignModal.show();
  }

  // Fonction pour réassigner une tâche
  function reassignTask() {
    const taskId = document.getElementById('taskIdForReassign').value;
    const userSelect = document.getElementById('reassignUserSelect');
    const selectedUsers = Array.from(userSelect.selectedOptions).map(option => option.value);

    if (selectedUsers.length === 0) {
      alert('Veuillez sélectionner au moins un destinataire');
      return;
    }

    // Disable the button to prevent double clicks
    const button = document.getElementById('reassignBtn');
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> En cours...';

    // Make API call
    fetch(`/api/tasks/${taskId}/reassign`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        assignees: selectedUsers
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Hide the modal
        const reassignModal = bootstrap.Modal.getInstance(document.getElementById('reassignModal'));
        reassignModal.hide();

        // Refresh tasks
        fetchTasks();

        // Show success message
        alert('La tâche a été réassignée avec succès');
      } else {
        const errorMessage = data.error ? data.error : 'Une erreur inconnue est survenue';
        alert(`Erreur: ${errorMessage}`);
        // Restore button
        button.disabled = false;
        button.innerHTML = originalText;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert(`Une erreur est survenue: ${error.message}`);
      // Restore button
      button.disabled = false;
      button.innerHTML = originalText;
    });
  }

  // Fonction pour ouvrir le modal de transfert de propriété
  function openOwnershipTransferModal(event, taskId) {
    event.preventDefault();

    // Mettre à jour l'ID de la tâche
    document.getElementById('taskIdForOwnershipTransfer').value = taskId;

    // Remplir le select avec les utilisateurs
    const userSelect = document.getElementById('ownershipTransferSelect');
    userSelect.innerHTML = '<option value="" disabled selected>Choisir un utilisateur</option>';

    // Charger les utilisateurs dans le select
    usersForTransfer.forEach(user => {
      // Exclure l'utilisateur courant
      if (user.email !== userEmail) {
        const option = document.createElement('option');
        option.value = user.email;
        option.textContent = user.name;
        userSelect.appendChild(option);
      }
    });

    // Afficher le modal
    const transferOwnershipModal = new bootstrap.Modal(document.getElementById('transferOwnershipModal'));
    transferOwnershipModal.show();
  }

  // Fonction pour transférer la propriété d'une tâche
  function transferTaskOwnership() {
    const taskId = document.getElementById('taskIdForOwnershipTransfer').value;
    const newOwner = document.getElementById('ownershipTransferSelect').value;

    if (!newOwner) {
      alert('Veuillez sélectionner un nouveau propriétaire');
      return;
    }

    // Disable the button to prevent double clicks
    const button = document.getElementById('transferOwnershipBtn');
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> En cours...';

    // Make API call
    fetch(`/api/tasks/${taskId}/transfer-ownership`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        new_owner: newOwner
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Hide the modal
        const transferOwnershipModal = bootstrap.Modal.getInstance(document.getElementById('transferOwnershipModal'));
        transferOwnershipModal.hide();

        // Refresh tasks
        fetchTasks();

        // Show success message
        alert('La propriété de la tâche a été transférée avec succès');
      } else {
        const errorMessage = data.error ? data.error : 'Une erreur inconnue est survenue';
        alert(`Erreur: ${errorMessage}`);
        // Restore button
        button.disabled = false;
        button.innerHTML = originalText;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert(`Une erreur est survenue: ${error.message}`);
      // Restore button
      button.disabled = false;
      button.innerHTML = originalText;
    });
  }

  // Fonction pour gérer les rappels de tâches
  function handleReminderAction(event, taskId) {
    event.preventDefault();

    // Disable the button to prevent double clicks
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Envoi...';

    console.log(`Sending reminder for task ${taskId}`);

    // Make API call
    fetch(`/api/tasks/${taskId}/remind`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Show success message
        alert('Rappel envoyé avec succès !');
        // Enable the button
        button.disabled = false;
        button.innerHTML = originalText;
      } else {
        const errorMessage = data.error ? data.error : 'Une erreur inconnue est survenue';
        alert(`Erreur: ${errorMessage}`);
        // Restore button
        button.disabled = false;
        button.innerHTML = originalText;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert(`Une erreur est survenue: ${error.message}`);
      // Restore button
      button.disabled = false;
      button.innerHTML = originalText;
    });
  }

  // Handle task action button clicks
  function handleTaskAction(event, taskId, action) {
    event.preventDefault();

    // Disable the button to prevent double clicks
    const button = event.target.closest('button');
    const originalText = button.innerHTMLbutton.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> En cours...';

    console.log(`Executing action ${action} on task ${taskId}`);

    // Make API call
    fetch(`/api/tasks/${taskId}/${action}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Refresh tasks after successful action
        fetchTasks();
      } else {
        const errorMessage = data.error ? data.error : 'Une erreur inconnue est survenue';
        alert(`Erreur: ${errorMessage}`);
        // Restore button
        button.disabled = false;
        button.innerHTML = originalText;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert(`Une erreur est survenue: ${error.message}`);
      // Restore button
      button.disabled = false;
      button.innerHTML = originalText;
    });
  }

  // Handle change priority
  function openPriorityModal(taskId, currentPriority) {
    document.getElementById('taskIdForPriority').value = taskId;

    // Select the current priority radio
    document.querySelectorAll('input[name="taskPriority"]').forEach(radio => {
      radio.checked = (radio.value === currentPriority);
    });

    // Show the modal
    const priorityModal = new bootstrap.Modal(document.getElementById('priorityModal'));
    priorityModal.show();
  }

  // Save priority changes
  document.getElementById('savePriorityBtn').addEventListener('click', function() {
    const taskId = document.getElementById('taskIdForPriority').value;
    const selectedPriority = document.querySelector('input[name="taskPriority"]:checked').value;

    // Disable the button to prevent double clicks
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enregistrement...';

    // Make API call to change priority
    fetch(`/api/tasks/${taskId}/priority`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        priority: selectedPriority
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Hide the modal
        const priorityModal = bootstrap.Modal.getInstance(document.getElementById('priorityModal'));
        priorityModal.hide();

        // Refresh tasks
        fetchTasks();
      } else {
        alert(`Erreur: ${data.error || 'Une erreur est survenue'}`);

        // Re-enable the button
        this.disabled = false;
        this.innerHTML = 'Enregistrer';
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert(`Une erreur est survenue: ${error.message}`);

      // Re-enable the button
      this.disabled = false;
      this.innerHTML = 'Enregistrer';
    });
  });

  // Create task card HTML
  function createTaskCard(task) {
    const isTaskAssigner = task.assigned_by === userEmail;
    const canManageTask = task.can_manage || task.assigned_by === userEmail;
    const isAssignee = task.assignees.includes(userEmail);

    // Debug: log task info
    console.log(`Creating card for task ${task.id}:`, {
      subject: task.subject,
      state: task.state,
      priority: task.priority,
      is_assigner: isTaskAssigner,
      can_manage: canManageTask,
      is_assignee: isAssignee,
      time_info: task.time_info,
      transfer_from: task.transfer_from,
      transfer_to: task.transfer_to,
      history: task.history || []
    });

    let actionButtons = '';

    if (task.state === 'assigned') {
      // Only show these buttons to assignees
      if (isAssignee) {
        actionButtons += `
          <button onclick="handleTaskAction(event, ${task.id}, 'dispute')" class="btn btn-danger btn-sm">Contester</button>
          <button onclick="handleTaskAction(event, ${task.id}, 'validate')" class="btn btn-warning btn-sm">Faire valider</button>
          <button onclick="releaseTask(event, ${task.id})" class="btn btn-info btn-sm">
            <i class="fa fa-unlock"></i> Libérer
          </button>
        `;
      }

      if (canManageTask) {
        actionButtons += `
          <button onclick="handleTaskAction(event, ${task.id}, 'complete')" class="btn btn-success btn-sm">Terminer</button>
        `;
      }

      // Ajouter le bouton de rappel pour les tâches assignées avec des assignés
      if (canManageTask && task.assignees.length > 0) {
        actionButtons += `
          <button onclick="handleReminderAction(event, ${task.id})" class="btn btn-info btn-sm">
            <i class="fa fa-bell"></i> Relancer
          </button>
        `;
      }

      // Pour le créateur: ajouter des boutons pour réassigner et transférer la propriété
      if (isTaskAssigner && task.assignees.length > 0) {
        actionButtons += `
          <button onclick="openReassignModal(event, ${task.id}, ${JSON.stringify(task.assignees)})" class="btn btn-primary btn-sm">
            <i class="fa fa-users"></i> Réassigner
          </button>
          <button onclick="openOwnershipTransferModal(event, ${task.id})" class="btn btn-secondary btn-sm">
            <i class="fa fa-exchange"></i> Transférer propriété
          </button>
        `;
      }
    } else if (task.state === 'disputed') {
      if (canManageTask) {
        actionButtons += `
          <button onclick="handleTaskAction(event, ${task.id}, 'reject-dispute')" class="btn btn-warning btn-sm">Rejeter la contestation</button>
          <button onclick="handleTaskAction(event, ${task.id}, 'delete')" class="btn btn-danger btn-sm">Supprimer la tâche</button>
        `;
      }
    } else if (task.state === 'to_validated') {
      if (canManageTask) {
        actionButtons += `
          <button onclick="handleTaskAction(event, ${task.id}, 'complete')" class="btn btn-success btn-sm">Valider la tâche</button>
          <button onclick="handleTaskAction(event, ${task.id}, 'reject-validation')" class="btn btn-danger btn-sm">Refuser la validation</button>
        `;
      }
      // Allow assignees to cancel their validation request
      if (isAssignee) {
        actionButtons += `
          <button onclick="handleTaskAction(event, ${task.id}, 'cancel-validation')" class="btn btn-secondary btn-sm">Annuler la validation</button>
        `;
      }
    } else if (task.state === 'transfer_pending') {
      // Afficher des boutons pour approuver/rejeter la cession si on est le créateur
      if (isTaskAssigner) {
        actionButtons += `
          <button onclick="handleTaskAction(event, ${task.id}, 'approve-transfer')" class="btn btn-success btn-sm">
            Approuver la cession
          </button>
          <button onclick="handleTaskAction(event, ${task.id}, 'reject-transfer')" class="btn btn-danger btn-sm">
            Rejeter la cession
          </button>
        `;
      }

      // Afficher un message spécial si on est celui qui a demandé la cession
      if (task.transfer_from === userEmail) {
        actionButtons += `
          <span class="task-badge badge-info">En attente d'approbation de cession</span>
        `;
      }
    } else if (task.state === 'done') {
      // Allow assigner/admin to reopen completed tasks
      if (canManageTask) {
        actionButtons += `
          <button onclick="handleTaskAction(event, ${task.id}, 'reopen')" class="btn btn-info btn-sm">Réouvrir la tâche</button>
        `;
      }
    }

    // Add delete button for admin/assigners at all times except disputed state
    if (canManageTask && task.state !== 'disputed') {
      actionButtons += `
        <button onclick="handleTaskAction(event, ${task.id}, 'delete')" class="btn btn-danger btn-sm">Supprimer</button>
      `;
    }

    // Add priority change button for admin/assigners
    if (canManageTask) {
      actionButtons += `
        <button onclick="openPriorityModal(${task.id}, '${task.priority}')" class="btn btn-info btn-sm">Changer la priorité</button>
      `;
    }

    // Add history button
    if (task.history && task.history.length > 0) {
      actionButtons += `
        <button onclick="openHistoryModal(event, ${task.id}, ${JSON.stringify(task.history)})" class="btn btn-secondary btn-sm">
          <i class="fa fa-history"></i> Historique
        </button>
      `;
    }

    // Format time info
    let timeInfoHTML = '';
    if (task.time_info) {
      const timeInfoClass = getTimeInfoClass(task.time_info);
      timeInfoHTML = `
        <div class="time-info ${timeInfoClass}">
          <i class="fa fa-clock"></i> ${task.time_info.message}
        </div>
      `;
    }

    // Show role badge for task (assigned by you or assigned to you)
    let roleBadgeHtml = '';
    if (task.is_assigner) {
      roleBadgeHtml = '<span class="task-badge badge-info">Attribuée par vous</span>';
    } else if (task.assignees.includes(userEmail)) {
      roleBadgeHtml = '<span class="task-badge badge-info">Attribuée à vous</span>';
    }

    // Information sur la cession en cours si applicable
    let transferInfoHtml = '';
    if (task.state === 'transfer_pending' && task.transfer_from && task.transfer_to) {
      transferInfoHtml = `<div class="text-info"><strong>En attente de cession</strong> : De ${task.transfer_from} à ${task.transfer_to}</div>`;
    }

    // Afficher les rôles cibles si présents
    let targetRolesBadgesHtml = '';
    if (task.target_roles && task.target_roles.length > 0) {
      targetRolesBadgesHtml = task.target_roles.map(role =>
        `<span class="role-badge">Rôle: ${role}</span>`
      ).join(' ');
    }

    // Get list of assignees
    const assigneesText = task.assignees.length > 0
      ? `<div class="float-right text-muted small">Attribuée à: ${task.assignees.join(', ')}</div>`
      : '';

    return `
      <div class="task-card card priority-${task.priority}" data-task-state="${task.state}" data-task-priority="${task.priority}">
        <div class="card-body">
          <div class="float-right text-muted small">Attribuée par: ${task.assigned_by}</div>
          ${assigneesText}
          <div class="float-right text-muted small">Début: ${formatDate(task.start_date)}</div>
          <div class="float-right text-muted small">Fin: ${formatDate(task.due_date)}</div>
          ${timeInfoHTML}
          ${transferInfoHtml}
          <div class="mb-2">
            <span class="task-badge ${getStateBadgeClass(task.state)}">${stateTranslations[task.state]}</span>
            ${getPriorityBadge(task.priority)}
            ${roleBadgeHtml}
          </div>
          <div class="mb-2">
            ${targetRolesBadgesHtml}
          </div>
          <h4 class="card-title">${task.subject}</h4>
          <p class="card-text">${task.description || 'Pas de description'}</p>
          <div class="task-actions">
            ${actionButtons}
          </div>
        </div>
      </div>
    `;
  }

  // Fetch tasks from API
  let currentStateFilter = 'all';
  let currentPriorityFilter = 'all';

  function fetchTasks() {
    const tasksContainer = document.getElementById('tasks-container');
    tasksContainer.innerHTML = `
      <div class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Chargement...</span>
        </div>
      </div>
    `;

    fetch('/api/tasks')
      .then(response => response.json())
      .then(tasks => {
        if (tasks.length === 0) {
          tasksContainer.innerHTML = `
            <div class="no-tasks">
              <p>Aucune tâche trouvée</p>
            </div>
          `;
        } else {
          // Filter tasks based on current state filter
          let filteredTasks = tasks;

          if (currentStateFilter !== 'all') {
            filteredTasks = filteredTasks.filter(task => task.state === currentStateFilter);
          }

          // Filter by priority if needed
          if (currentPriorityFilter !== 'all') {
            filteredTasks = filteredTasks.filter(task => task.priority === currentPriorityFilter);
          }

          if (filteredTasks.length === 0) {
            tasksContainer.innerHTML = `
              <div class="no-tasks">
                <p>Aucune tâche ne correspond aux filtres sélectionnés</p>
              </div>
            `;
          } else {
            // Create HTML for each task card
            const tasksHTML = filteredTasks.map(task => createTaskCard(task)).join('');
            tasksContainer.innerHTML = tasksHTML;
          }
        }
      })
      .catch(error => {
        console.error('Error:', error);
        tasksContainer.innerHTML = `
          <div class="alert alert-danger">
            Une erreur est survenue lors du chargement des tâches. Veuillez réessayer.
          </div>
        `;
      });
  }

  // Initial fetch
  fetchTasks();

  // Set up automatic refresh every 30 seconds
  setInterval(fetchTasks, 30000);

  // Set up filter options for task state
  document.querySelectorAll('.filter-option').forEach(option => {
    option.addEventListener('click', function(e) {
      e.preventDefault();
      currentStateFilter = this.dataset.filter;
      document.querySelectorAll('.filter-option').forEach(opt => opt.classList.remove('active'));
      this.classList.add('active');
      fetchTasks();
    });
  });

  // Set up filter options for task priority
  document.querySelectorAll('.priority-filter-option').forEach(option => {
    option.addEventListener('click', function(e) {
      e.preventDefault();
      currentPriorityFilter = this.dataset.priority;
      document.querySelectorAll('.priority-filter-option').forEach(opt => opt.classList.remove('active'));
      this.classList.add('active');
      fetchTasks();
    });
  });
</script>
{% endblock %}